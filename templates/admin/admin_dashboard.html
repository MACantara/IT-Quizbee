{% extends "base.html" %}

{% block title %}Admin Dashboard - IT Quizbee{% endblock %}

{% block extra_css %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
{% endblock %}

{% block content %}
<!-- Admin Dashboard Navigation Bar -->
<div class="bg-white shadow-lg border-b-4 border-indigo-600 rounded-xl mb-8 -mx-4 px-4 py-4">
    <div class="flex justify-between items-center">
        <div class="flex items-center space-x-3">
            <i class="bi bi-speedometer2 text-3xl text-indigo-600"></i>
            <h1 class="text-2xl font-bold text-gray-800">Admin Dashboard</h1>
        </div>
        <a href="{{ url_for('admin.logout') }}" class="flex items-center space-x-2 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">
            <i class="bi bi-box-arrow-right"></i>
            <span>Logout</span>
        </a>
    </div>
</div>

<!-- Loading State -->
<div id="loading" class="hidden text-center py-20">
    <div class="inline-block animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-indigo-600"></div>
    <p class="mt-4 text-gray-600 text-lg">Loading analytics data...</p>
</div>

<!-- Dashboard Content -->
<div id="dashboard">
    <!-- Summary Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <!-- Total Attempts Card -->
        <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-blue-500 hover:shadow-xl transition">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-500 text-sm font-medium">Total Attempts</p>
                    <h3 id="totalAttempts" class="text-3xl font-bold text-gray-800 mt-1">{{ statistics.overview.total_attempts }}</h3>
                </div>
                <div class="bg-blue-100 rounded-full p-3">
                    <i class="bi bi-file-earmark-text text-3xl text-blue-600"></i>
                </div>
            </div>
        </div>

        <!-- Average Score Card -->
        <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-green-500 hover:shadow-xl transition">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-500 text-sm font-medium">Average Score</p>
                    <h3 id="avgScore" class="text-3xl font-bold text-gray-800 mt-1">{{ "%.1f"|format(statistics.overview.average_score) }}%</h3>
                </div>
                <div class="bg-green-100 rounded-full p-3">
                    <i class="bi bi-graph-up text-3xl text-green-600"></i>
                </div>
            </div>
        </div>

        <!-- Pass Rate Card -->
        <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-purple-500 hover:shadow-xl transition">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-500 text-sm font-medium">Pass Rate</p>
                    <h3 id="passRate" class="text-3xl font-bold text-gray-800 mt-1">{{ "%.1f"|format(statistics.overview.pass_rate) }}%</h3>
                </div>
                <div class="bg-purple-100 rounded-full p-3">
                    <i class="bi bi-trophy text-3xl text-purple-600"></i>
                </div>
            </div>
        </div>

        <!-- Average Time Card -->
        <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-orange-500 hover:shadow-xl transition">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-500 text-sm font-medium">Avg Time (seconds)</p>
                    <h3 id="avgTime" class="text-3xl font-bold text-gray-800 mt-1">{{ "%.0f"|format(statistics.overview.average_time) }}</h3>
                </div>
                <div class="bg-orange-100 rounded-full p-3">
                    <i class="bi bi-clock text-3xl text-orange-600"></i>
                </div>
            </div>
        </div>
    </div>

            <!-- Charts Row 1 -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                <!-- Performance by Mode Chart -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                        <i class="bi bi-bar-chart-fill text-indigo-600 mr-2"></i>
                        Performance by Quiz Mode
                    </h3>
                    <canvas id="modeChart"></canvas>
                </div>

                <!-- Performance by Difficulty Chart -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                        <i class="bi bi-graph-up-arrow text-indigo-600 mr-2"></i>
                        Performance by Difficulty (Finals Mode)
                    </h3>
                    <canvas id="difficultyChart"></canvas>
                </div>
            </div>

            <!-- Charts Row 2 -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                <!-- Performance Trend Chart -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-gray-800 flex items-center">
                            <i class="bi bi-graph-up text-indigo-600 mr-2"></i>
                            Performance Trend (Last 30 Days)
                        </h3>
                        <select id="trendInterval" class="px-3 py-1 border border-gray-300 rounded-lg text-sm">
                            <option value="day">Daily</option>
                            <option value="week">Weekly</option>
                            <option value="month">Monthly</option>
                        </select>
                    </div>
                    <canvas id="trendChart"></canvas>
                </div>

                <!-- Topic Performance Chart -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                        <i class="bi bi-pie-chart-fill text-indigo-600 mr-2"></i>
                        Performance by Topic
                    </h3>
                    <canvas id="topicChart"></canvas>
                </div>
            </div>

            <!-- Recent Attempts Table -->
            <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold text-gray-800 flex items-center">
                        <i class="bi bi-clock-history text-indigo-600 mr-2"></i>
                        Recent Quiz Attempts
                    </h3>
                    <div class="flex space-x-2">
                        <select id="filterMode" class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
                            <option value="">All Modes</option>
                            <option value="elimination_full">Elimination Full</option>
                            <option value="finals_full">Finals Full</option>
                            <option value="review">Review</option>
                        </select>
                        <select id="filterDays" class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
                            <option value="7">Last 7 Days</option>
                            <option value="14">Last 14 Days</option>
                            <option value="30">Last 30 Days</option>
                            <option value="90">Last 90 Days</option>
                        </select>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mode</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Difficulty</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Score</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Questions</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
                            </tr>
                        </thead>
                        <tbody id="recentAttemptsTable" class="bg-white divide-y divide-gray-200">
                            <!-- Populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Statistics Grid -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                <!-- Mode Statistics -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                        <i class="bi bi-list-check text-indigo-600 mr-2"></i>
                        Mode Statistics
                    </h3>
                    <div class="space-y-3">
                        {% for mode, stats in statistics.by_mode.items() %}
                        <div class="border-l-4 border-indigo-400 pl-3 py-2">
                            <p class="text-sm font-medium text-gray-600">{{ mode|replace('_', ' ')|title }}</p>
                            <p class="text-2xl font-bold text-gray-800">{{ "%.1f"|format(stats.average_score) }}%</p>
                            <p class="text-xs text-gray-500">{{ stats.count }} attempts</p>
                        </div>
                        {% else %}
                        <p class="text-gray-500 text-center py-4">No mode data available</p>
                        {% endfor %}
                    </div>
                </div>

                <!-- Difficulty Statistics -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                        <i class="bi bi-speedometer text-indigo-600 mr-2"></i>
                        Difficulty Statistics
                    </h3>
                    <div class="space-y-3">
                        {% for difficulty, stats in statistics.by_difficulty.items() %}
                        <div class="border-l-4 {% if difficulty == 'easy' %}border-green-400{% elif difficulty == 'average' %}border-yellow-400{% else %}border-red-400{% endif %} pl-3 py-2">
                            <p class="text-sm font-medium text-gray-600 capitalize">{{ difficulty }}</p>
                            <p class="text-2xl font-bold text-gray-800">{{ "%.1f"|format(stats.average_score) }}%</p>
                            <p class="text-xs text-gray-500">{{ stats.count }} attempts</p>
                        </div>
                        {% else %}
                        <p class="text-gray-500 text-center py-4">No difficulty data available</p>
                        {% endfor %}
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                        <i class="bi bi-lightning text-indigo-600 mr-2"></i>
                        Quick Actions
                    </h3>
                    <div class="space-y-3">
                        <button onclick="window.location.reload()" class="w-full px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition flex items-center justify-center">
                            <i class="bi bi-arrow-clockwise mr-2"></i>
                            Refresh Data
                        </button>
                        <a href="/api/statistics/export" class="block w-full px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition text-center">
                            <i class="bi bi-download mr-2"></i>
                            Export Analytics
                        </a>
                        <a href="/api/health" target="_blank" class="block w-full px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition text-center">
                            <i class="bi bi-code-square mr-2"></i>
                            API Health
                        </a>
                    </div>
                </div>
            </div>

            <!-- Recent Activity -->
            {% if statistics.recent_activity %}
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    <i class="bi bi-clock-history text-indigo-600 mr-2"></i>
                    Recent Quiz Attempts
                </h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mode</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Score</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Time</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            {% for activity in statistics.recent_activity %}
                            <tr class="hover:bg-gray-50">
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                    <span class="flex items-center">
                                        <i class="bi bi-person-circle text-gray-500 mr-1"></i>
                                        {{ activity.user_name or 'Anonymous' }}
                                    </span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                    <span class="px-2 py-1 bg-indigo-100 text-indigo-800 rounded-full text-xs font-medium">
                                        {{ activity.quiz_type|replace('_', ' ')|title }}
                                    </span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold {% if activity.score >= 80 %}text-green-600{% elif activity.score >= 60 %}text-yellow-600{% else %}text-red-600{% endif %}">
                                    {{ "%.1f"|format(activity.score) }}%
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                    {{ activity.time_ago }}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Error State -->
        <div id="error" class="hidden text-center py-20">
            <i class="bi bi-exclamation-triangle text-6xl text-red-500"></i>
            <h2 class="text-2xl font-bold text-gray-800 mt-4">Error Loading Data</h2>
            <p id="errorMessage" class="text-gray-600 mt-2"></p>
            <button onclick="refreshDashboard()" class="mt-6 px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
                Try Again
            </button>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script>
    // Initialize charts with server-side data
    document.addEventListener('DOMContentLoaded', function() {
        initializeCharts();
    });

    function initializeCharts() {
        // Server-side data
        const modeData = {{ statistics.by_mode|tojson }};
        const difficultyData = {{ statistics.by_difficulty|tojson }};
        const topicData = {{ statistics.by_topic|tojson }};

        // Initialize Mode Chart
        initModeChart(modeData);
        
        // Initialize Difficulty Chart
        initDifficultyChart(difficultyData);
        
        // Initialize Topic Chart
        initTopicChart(topicData);
    }

    function initModeChart(data) {
        if (!data || Object.keys(data).length === 0) {
            document.getElementById('modeChart').parentElement.innerHTML += '<p class="text-gray-500 text-center py-8">No mode data available</p>';
            return;
        }

        const ctx = document.getElementById('modeChart').getContext('2d');
        const modes = Object.keys(data);
        const avgScores = modes.map(mode => data[mode].average_score || 0);
        const counts = modes.map(mode => data[mode].count || 0);

        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: modes.map(formatModeName),
                datasets: [{
                    label: 'Average Score (%)',
                    data: avgScores,
                    backgroundColor: 'rgba(99, 102, 241, 0.6)',
                    borderColor: 'rgba(99, 102, 241, 1)',
                    borderWidth: 2,
                    yAxisID: 'y'
                }, {
                    label: 'Number of Attempts',
                    data: counts,
                    backgroundColor: 'rgba(34, 197, 94, 0.6)',
                    borderColor: 'rgba(34, 197, 94, 1)',
                    borderWidth: 2,
                    yAxisID: 'y1'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                scales: {
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: {
                            display: true,
                            text: 'Average Score (%)'
                        },
                        max: 100
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: {
                            display: true,
                            text: 'Number of Attempts'
                        },
                        grid: {
                            drawOnChartArea: false
                        }
                    }
                }
            }
        });
    }

    function initDifficultyChart(data) {
        if (!data || Object.keys(data).length === 0) {
            document.getElementById('difficultyChart').parentElement.innerHTML += '<p class="text-gray-500 text-center py-8">No difficulty data available</p>';
            return;
        }

        const ctx = document.getElementById('difficultyChart').getContext('2d');
        const difficulties = Object.keys(data);
        const avgScores = difficulties.map(d => data[d].average_score || 0);

        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: difficulties.map(d => d.charAt(0).toUpperCase() + d.slice(1)),
                datasets: [{
                    label: 'Average Score',
                    data: avgScores,
                    backgroundColor: [
                        'rgba(34, 197, 94, 0.8)',
                        'rgba(234, 179, 8, 0.8)',
                        'rgba(239, 68, 68, 0.8)'
                    ],
                    borderColor: [
                        'rgba(34, 197, 94, 1)',
                        'rgba(234, 179, 8, 1)',
                        'rgba(239, 68, 68, 1)'
                    ],
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    }

    function initTopicChart(data) {
        if (!data || Object.keys(data).length === 0) {
            document.getElementById('topicChart').parentElement.innerHTML = `
                <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    <i class="bi bi-pie-chart-fill text-indigo-600 mr-2"></i>
                    Performance by Topic
                </h3>
                <p class="text-gray-500 text-center py-8">No topic data available</p>
            `;
            return;
        }

        const ctx = document.getElementById('topicChart').getContext('2d');
        const topics = Object.keys(data);
        const avgScores = topics.map(t => data[t].average_score || 0);

        new Chart(ctx, {
            type: 'pie',
            data: {
                labels: topics.map(formatTopicName),
                datasets: [{
                    label: 'Average Score',
                    data: avgScores,
                    backgroundColor: generateColors(topics.length),
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    }

    function formatModeName(mode) {
        const names = {
            'elimination': 'Elimination',
            'finals': 'Finals'
        };
        return names[mode] || mode.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
    }

    function formatTopicName(topicId) {
        return topicId.split('_').map(word => 
            word.charAt(0).toUpperCase() + word.slice(1)
        ).join(' ');
    }

    function generateColors(count) {
        const colors = [
            'rgba(99, 102, 241, 0.8)',
            'rgba(34, 197, 94, 0.8)',
            'rgba(234, 179, 8, 0.8)',
            'rgba(239, 68, 68, 0.8)',
            'rgba(168, 85, 247, 0.8)',
            'rgba(236, 72, 153, 0.8)',
            'rgba(14, 165, 233, 0.8)',
            'rgba(249, 115, 22, 0.8)',
            'rgba(20, 184, 166, 0.8)',
            'rgba(132, 204, 22, 0.8)'
        ];
        return colors.slice(0, count);
    }
</script>
{% endblock %}
