{% extends "base.html" %}

{% block title %}IT Quizbee - Elimination Mode{% endblock %}

{% block content %}
<!-- User Name Modal -->
<div id="nameModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
    <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full mx-4 animate-fade-in">
        <div class="text-center mb-6">
            <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="bi bi-person-fill text-3xl text-blue-600"></i>
            </div>
            <h2 class="text-2xl font-bold text-gray-800">Welcome to Elimination Mode!</h2>
            <p class="text-gray-600 mt-2">Please enter your name to begin</p>
        </div>
        
        <form id="nameForm" class="space-y-4">
            <div>
                <label for="userName" class="block text-sm font-semibold text-gray-700 mb-2">Your Name</label>
                <input type="text" 
                       id="userName" 
                       name="userName" 
                       class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                       placeholder="Enter your name"
                       required>
            </div>
            
            <button type="submit" class="w-full px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-semibold">
                <i class="bi bi-arrow-right-circle-fill mr-2"></i>Start Quiz
            </button>
        </form>
    </div>
</div>

<div class="max-w-6xl mx-auto animate-fade-in">
    <form method="POST" action="{{ url_for('quiz.submit_quiz') }}" id="eliminationForm">
        <input type="hidden" name="user_name" id="userNameHidden">
        <div class="bg-white rounded-2xl shadow-xl p-8">
            <!-- Header with Timer -->
            <div class="flex items-center justify-between mb-6">
                <div>
                    <div class="px-4 py-2 rounded-full font-semibold text-sm bg-blue-100 text-blue-800 inline-block">
                        âš¡ Elimination Mode
                    </div>
                    <h2 class="text-2xl font-bold text-gray-800 mt-2">100 Questions from All Topics</h2>
                </div>
                <div class="text-center">
                    <div class="text-sm text-gray-600 mb-1">Time Remaining</div>
                    <div id="timer" class="text-4xl font-bold text-blue-600">60:00</div>
                </div>
            </div>

            <!-- Progress Bar -->
            <div class="mb-6">
                <div class="flex justify-between text-sm text-gray-600 mb-2">
                    <span>Progress</span>
                    <span id="progress-text">0 / 100</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-3">
                    <div id="progress-bar" class="bg-blue-600 h-3 rounded-full transition-all" style="width: 0%"></div>
                </div>
            </div>

            <!-- Questions -->
            <div class="space-y-6">
                {% for question in questions %}
                <div class="pb-6 border-b border-gray-200 last:border-b-0">
                    <h3 class="text-lg font-bold text-gray-800 mb-3">
                        {{ loop.index }}. {{ question.question }}
                    </h3>
                    <div class="text-xs text-gray-500 mb-3">
                        <i class="bi bi-tag-fill"></i> {{ question.topic_name }} - {{ question.subtopic_name }}
                    </div>
                    
                    <!-- Multiple Choice Options -->
                    <div class="space-y-2">
                        {% for option in question.options %}
                        <label class="flex items-center gap-3 p-3 border-2 border-gray-300 rounded-lg cursor-pointer hover:border-blue-400 hover:bg-blue-50 transition has-[:checked]:border-blue-600 has-[:checked]:bg-blue-50 question-option">
                            <input type="radio" 
                                   name="question_{{ question.id }}" 
                                   value="{{ loop.index0 }}" 
                                   class="w-4 h-4 text-blue-600"
                                   required>
                            <span class="font-semibold text-gray-700">{{ ['A', 'B', 'C', 'D'][loop.index0] }}.</span>
                            <span class="text-gray-800">{{ option }}</span>
                        </label>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Submit Button -->
            <div class="flex gap-4 justify-center mt-8 sticky bottom-4">
                <a href="{{ url_for('navigation.index') }}" class="px-6 py-3 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition">
                    <i class="bi bi-arrow-left mr-2"></i>Back to Home
                </a>
                <button type="submit" class="px-8 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition font-semibold">
                    <i class="bi bi-check-circle-fill mr-2"></i>Submit Quiz
                </button>
            </div>
        </div>
    </form>
</div>

<script>
// User Name Modal Handling
const nameModal = document.getElementById('nameModal');
const nameForm = document.getElementById('nameForm');
const userNameInput = document.getElementById('userName');
const userNameHidden = document.getElementById('userNameHidden');

// Check if name is already stored
const storedName = localStorage.getItem('quizUserName');
if (storedName) {
    userNameInput.value = storedName;
}

// Handle name submission
nameForm.addEventListener('submit', function(e) {
    e.preventDefault();
    const userName = userNameInput.value.trim();
    
    if (userName) {
        // Store name in localStorage
        localStorage.setItem('quizUserName', userName);
        
        // Set hidden field value
        userNameHidden.value = userName;
        
        // Hide modal
        nameModal.classList.add('hidden');
        
        // Start timer
        startTimer();
    }
});

// Timer functionality - 60 minutes
let timeLeft = 60 * 60; // 60 minutes in seconds
const timerElement = document.getElementById('timer');
const formElement = document.getElementById('eliminationForm');
let timerInterval;

function updateTimer() {
    const minutes = Math.floor(timeLeft / 60);
    const seconds = timeLeft % 60;
    timerElement.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
    
    // Change color when time is running out
    if (timeLeft <= 300) { // 5 minutes
        timerElement.classList.remove('text-blue-600');
        timerElement.classList.add('text-red-600');
    }
    
    if (timeLeft <= 0) {
        clearInterval(timerInterval);
        alert('Time is up! Submitting your answers...');
        formElement.submit();
    }
    
    timeLeft--;
}

function startTimer() {
    timerInterval = setInterval(updateTimer, 1000);
}

// Progress tracking
const totalQuestions = {{ questions|length }};
const progressBar = document.getElementById('progress-bar');
const progressText = document.getElementById('progress-text');

document.querySelectorAll('.question-option input[type="radio"]').forEach(radio => {
    radio.addEventListener('change', updateProgress);
});

function updateProgress() {
    // Count all radio button groups that have a selection
    const questionGroups = document.querySelectorAll('input[type="radio"][name^="question_"]');
    const uniqueNames = new Set();
    questionGroups.forEach(radio => {
        uniqueNames.add(radio.name);
    });
    
    let answeredCount = 0;
    uniqueNames.forEach(name => {
        if (document.querySelector(`input[name="${name}"]:checked`)) {
            answeredCount++;
        }
    });
    
    const percentage = (answeredCount / totalQuestions) * 100;
    progressBar.style.width = percentage + '%';
    progressText.textContent = `${answeredCount} / ${totalQuestions}`;
}

// Warn before leaving
window.addEventListener('beforeunload', function (e) {
    if (!nameModal.classList.contains('hidden')) {
        return; // Don't warn if modal is still open
    }
    e.preventDefault();
    e.returnValue = '';
});

// Confirm submission
formElement.addEventListener('submit', function(e) {
    if (nameModal.classList.contains('hidden')) {
        let answeredCount = 0;
        for (let i = 0; i < totalQuestions; i++) {
            if (document.querySelector(`input[name="answer_${i}"]:checked`)) {
                answeredCount++;
            }
        }
        
        if (answeredCount < totalQuestions) {
            if (!confirm(`You have ${totalQuestions - answeredCount} unanswered question(s). Do you want to submit anyway?`)) {
                e.preventDefault();
                return;
            }
        }
        
        clearInterval(timerInterval);
    }
});
</script>
{% endblock %}
