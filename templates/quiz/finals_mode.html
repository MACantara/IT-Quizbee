{% extends "base.html" %}

{% block title %}IT Quizbee - Finals Mode{% endblock %}

{% block content %}
<!-- User Name Modal -->
<div id="nameModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
    <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full mx-4 animate-fade-in">
        <div class="text-center mb-6">
            <div class="w-16 h-16 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="bi bi-person-fill text-3xl text-purple-600"></i>
            </div>
            <h2 class="text-2xl font-bold text-gray-800">Welcome to Finals Mode!</h2>
            <p class="text-gray-600 mt-2">Please enter your name to begin</p>
        </div>
        
        <form id="nameForm" class="space-y-4">
            <div>
                <label for="userName" class="block text-sm font-semibold text-gray-700 mb-2">Your Name</label>
                <input type="text" 
                       id="userName" 
                       name="userName" 
                       class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:outline-none"
                       placeholder="Enter your name"
                       required>
            </div>
            
            <button type="submit" class="w-full px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition font-semibold">
                <i class="bi bi-arrow-right-circle-fill mr-2"></i>Start Quiz
            </button>
        </form>
    </div>
</div>

<div class="max-w-4xl mx-auto animate-fade-in">
    <div class="bg-white rounded-2xl shadow-xl p-8">
        <!-- Header -->
        <div class="text-center mb-6">
            <div class="px-4 py-2 rounded-full font-semibold text-sm bg-purple-100 text-purple-800 inline-block mb-2">
                üèÜ Finals Mode
            </div>
            <h2 class="text-3xl font-bold text-gray-800">Identification Questions</h2>
            <p class="text-gray-600 mt-2">Answer each question before the timer runs out!</p>
        </div>

        <!-- Progress -->
        <div class="mb-6">
            <div class="flex justify-between text-sm text-gray-600 mb-2">
                <span>Question</span>
                <span id="progress-text">1 / 30</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-3">
                <div id="progress-bar" class="bg-purple-600 h-3 rounded-full transition-all" style="width: 3.33%"></div>
            </div>
        </div>

        <!-- Question Display -->
        <div id="question-container" class="min-h-[400px]">
            <!-- Current Question -->
            <div class="text-center mb-8">
                <div id="difficulty-badge" class="inline-block px-4 py-2 rounded-full font-semibold text-sm mb-4"></div>
                <div id="timer" class="text-6xl font-bold mb-4"></div>
            </div>

            <div id="question-content" class="mb-8">
                <h3 id="question-text" class="text-2xl font-bold text-gray-800 mb-6 text-center"></h3>
                
                <!-- Answer Input -->
                <div class="space-y-4">
                    <input type="text" 
                           id="answer-input"
                           class="w-full px-6 py-4 text-xl border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:ring-2 focus:ring-purple-200 outline-none transition"
                           placeholder="Type your answer here..."
                           autocomplete="off">
                    <p class="text-sm text-gray-500 text-center">
                        <i class="bi bi-info-circle mr-1"></i>Case-insensitive. Be as specific as possible.
                    </p>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex gap-4 justify-center" id="action-buttons">
                <button id="submit-answer" class="px-8 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition font-semibold text-lg">
                    <i class="bi bi-check-circle-fill mr-2"></i>Submit Answer
                </button>
            </div>

            <!-- Quiz Complete Message (hidden initially) -->
            <div id="complete-message" class="hidden text-center">
                <i class="bi bi-trophy-fill text-8xl text-purple-600 mb-4"></i>
                <h3 class="text-3xl font-bold text-gray-800 mb-4">Quiz Complete!</h3>
                <p class="text-lg text-gray-600 mb-6">Calculating your results...</p>
            </div>
        </div>
    </div>
</div>

<script>
// User Name Modal Handling
const nameModal = document.getElementById('nameModal');
const nameForm = document.getElementById('nameForm');
const userNameInput = document.getElementById('userName');

// Check if name is already stored
const storedName = localStorage.getItem('quizUserName');
if (storedName) {
    userNameInput.value = storedName;
}

// Handle name submission
nameForm.addEventListener('submit', function(e) {
    e.preventDefault();
    const userName = userNameInput.value.trim();
    
    if (userName) {
        // Store name in localStorage
        localStorage.setItem('quizUserName', userName);
        
        // Hide modal
        nameModal.classList.add('hidden');
        
        // Start quiz
        showQuestion(0);
    }
});

// Questions data
const questions = {{ questions_json | safe }};
let currentQuestionIndex = 0;
let userAnswers = [];
let questionTimer = null;
let timeLeft = 0;

// Timer configurations (in seconds)
const timerConfig = {
    'easy': 20,
    'average': 30,
    'difficult': 40
};

// Difficulty badge config
const difficultyConfig = {
    'easy': { text: '‚≠ê Easy', class: 'bg-green-100 text-green-800' },
    'average': { text: '‚≠ê‚≠ê Average', class: 'bg-yellow-100 text-yellow-800' },
    'difficult': { text: '‚≠ê‚≠ê‚≠ê Difficult', class: 'bg-red-100 text-red-800' }
};

function showQuestion(index) {
    if (index >= questions.length) {
        showComplete();
        return;
    }

    const question = questions[index];
    currentQuestionIndex = index;

    // Update progress
    document.getElementById('progress-text').textContent = `${index + 1} / ${questions.length}`;
    const percentage = ((index + 1) / questions.length) * 100;
    document.getElementById('progress-bar').style.width = percentage + '%';

    // Update difficulty badge
    const difficultyBadge = document.getElementById('difficulty-badge');
    const config = difficultyConfig[question.difficulty];
    difficultyBadge.textContent = config.text;
    difficultyBadge.className = `inline-block px-4 py-2 rounded-full font-semibold text-sm mb-4 ${config.class}`;

    // Update question text
    document.getElementById('question-text').textContent = question.question;

    // Clear previous answer
    document.getElementById('answer-input').value = '';
    document.getElementById('answer-input').disabled = false;
    document.getElementById('answer-input').focus();

    // Start timer
    timeLeft = timerConfig[question.difficulty];
    updateTimer();
    if (questionTimer) clearInterval(questionTimer);
    questionTimer = setInterval(updateTimer, 1000);
}

function updateTimer() {
    const timerElement = document.getElementById('timer');
    timerElement.textContent = timeLeft;

    // Change color based on time
    if (timeLeft <= 5) {
        timerElement.classList.remove('text-purple-600', 'text-yellow-600');
        timerElement.classList.add('text-red-600');
    } else if (timeLeft <= 10) {
        timerElement.classList.remove('text-purple-600', 'text-red-600');
        timerElement.classList.add('text-yellow-600');
    } else {
        timerElement.classList.remove('text-yellow-600', 'text-red-600');
        timerElement.classList.add('text-purple-600');
    }

    if (timeLeft <= 0) {
        clearInterval(questionTimer);
        handleTimeUp();
    }

    timeLeft--;
}

function handleTimeUp() {
    // Auto-submit with empty answer
    const answerInput = document.getElementById('answer-input');
    answerInput.disabled = true;
    
    userAnswers.push({
        question_index: currentQuestionIndex,
        answer: ''
    });

    setTimeout(() => {
        showQuestion(currentQuestionIndex + 1);
    }, 1000);
}

function submitAnswer() {
    if (questionTimer) clearInterval(questionTimer);

    const answerInput = document.getElementById('answer-input');
    const answer = answerInput.value.trim();

    userAnswers.push({
        question_index: currentQuestionIndex,
        answer: answer
    });

    answerInput.disabled = true;

    // Move to next question after short delay
    setTimeout(() => {
        showQuestion(currentQuestionIndex + 1);
    }, 500);
}

function showComplete() {
    // Hide question content and buttons
    document.getElementById('question-content').classList.add('hidden');
    document.getElementById('action-buttons').classList.add('hidden');
    document.getElementById('complete-message').classList.remove('hidden');

    // Submit results to server
    setTimeout(() => {
        submitResults();
    }, 1500);
}

function submitResults() {
    // Prepare form data
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '{{ url_for("quiz.submit_finals") }}';

    // Add user name
    const userNameInput = document.createElement('input');
    userNameInput.type = 'hidden';
    userNameInput.name = 'user_name';
    userNameInput.value = localStorage.getItem('quizUserName') || 'Anonymous';
    form.appendChild(userNameInput);

    // Add answers as hidden inputs
    userAnswers.forEach((item, index) => {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = `answer_${item.question_index}`;
        input.value = item.answer;
        form.appendChild(input);
    });

    document.body.appendChild(form);
    form.submit();
}

// Event listeners
document.getElementById('submit-answer').addEventListener('click', submitAnswer);
document.getElementById('answer-input').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        submitAnswer();
    }
});

// Prevent leaving page
window.addEventListener('beforeunload', function (e) {
    if (currentQuestionIndex < questions.length) {
        e.preventDefault();
        e.returnValue = '';
    }
});

// Don't start quiz automatically - wait for name modal
// showQuestion(0);  // Moved to name modal submission
</script>
{% endblock %}
